<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>WEZZY | Voice & Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* --- –î–ò–ó–ê–ô–ù (DISCORD STYLE) --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #36393f; color: #dcddde; display: flex; height: 100vh; overflow: hidden; }

        /* –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å (–°–µ—Ä–≤–µ—Ä–∏) */
        .server-list { width: 72px; background-color: #202225; display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .server-icon { width: 48px; height: 48px; background-color: #36393f; border-radius: 50%; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #dbdee1; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .server-icon:hover, .server-icon.active { border-radius: 16px; background-color: #5865f2; color: white; }
        .sep { width: 32px; height: 2px; background-color: #36393f; margin: 8px 0; }

        /* –ü–∞–Ω–µ–ª—å –∫–∞–Ω–∞–ª—ñ–≤ */
        .sidebar { width: 240px; background-color: #2f3136; display: flex; flex-direction: column; }
        .server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: bold; color: white; box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        .channels-scroll { flex: 1; padding-top: 16px; overflow-y: auto; }
        .category { padding: 0 16px; margin-bottom: 5px; color: #8e9297; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        
        .channel-item { margin: 1px 8px; padding: 6px 8px; border-radius: 4px; cursor: pointer; color: #8e9297; display: flex; align-items: center; font-size: 15px; }
        .channel-item:hover { background-color: #34373c; color: #dcddde; }
        .channel-item.active { background-color: #393c43; color: white; }
        .icon { margin-right: 6px; color: #72767d; width: 20px; text-align: center; }

        /* –°–ø–∏—Å–æ–∫ –ª—é–¥–µ–π –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º—É */
        .voice-user-list { margin-left: 32px; margin-bottom: 5px; }
        .voice-user { display: flex; align-items: center; padding: 2px 0; }
        .v-avatar { width: 24px; height: 24px; border-radius: 50%; background-color: #5865f2; margin-right: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; border: 2px solid #2f3136; }
        .v-name { font-size: 14px; color: #b9bbbe; }

        /* –ü–∞–Ω–µ–ª—å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–∑–Ω–∏–∑—É) */
        .voice-panel { background-color: #292b2f; padding: 8px; border-bottom: 1px solid #202225; display: none; }
        .v-status { color: #3ba55c; font-size: 12px; font-weight: bold; }
        .v-channel { color: #b9bbbe; font-size: 12px; }
        .v-controls { display: flex; justify-content: flex-end; margin-top: 5px; }
        .btn-disconnect { background: none; border: none; color: #b9bbbe; cursor: pointer; }
        .btn-disconnect:hover { color: #ed4245; }

        /* –ß–∞—Ç */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #36393f; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid #26272d; font-weight: bold; color: white; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { display: flex; gap: 15px; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #5865f2; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .msg-info h4 { margin: 0; font-size: 16px; color: white; font-weight: 500; }
        .msg-time { font-size: 12px; color: #72767d; margin-left: 6px; font-weight: 400; }
        .msg-text { color: #dcddde; margin-top: 4px; word-break: break-word; }

        .input-area { padding: 16px; }
        .input-box { background-color: #40444b; border-radius: 8px; padding: 12px; }
        input { width: 100%; background: transparent; border: none; color: white; outline: none; font-size: 15px; }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—Ö–æ–¥—É */
        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #5865f2; display: flex; align-items: center; justify-content: center; z-index: 999; }
        .login-card { background: #36393f; padding: 30px; border-radius: 5px; text-align: center; width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 10px; background: #202225; border: none; border-radius: 3px; color: white; margin-bottom: 15px; }
        .login-btn { width: 100%; padding: 10px; background: #5865f2; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .login-btn:hover { background-color: #4752c4; }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-card">
            <h2 style="color: white; margin-top: 0;">–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</h2>
            <p style="color: #b9bbbe;">–í–≤–µ–¥–∏ –Ω—ñ–∫–Ω–µ–π–º –¥–ª—è –≤—Ö–æ–¥—É:</p>
            <input type="text" class="login-input" id="usernameInput" placeholder="–¢–≤–æ—î —ñ–º'—è...">
            <button class="login-btn" onclick="login()">–£–≤—ñ–π—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
        </div>
    </div>

    <div class="server-list">
        <div class="server-icon active">UA</div>
        <div class="server-icon">üéÆ</div>
        <div class="sep"></div>
        <div class="server-icon">+</div>
    </div>

    <div class="sidebar">
        <div class="server-header">WEZZY Community</div>
        <div class="channels-scroll">
            <div class="category">Text Channels</div>
            <div class="channel-item active"><span class="icon">#</span> –≥–æ–ª–æ–≤–Ω–∏–π</div>
            <div class="channel-item"><span class="icon">#</span> —Ñ–ª—É–¥–∏–ª–∫–∞</div>
            
            <br>
            <div class="category">Voice Channels</div>
            
            <div class="channel-item" onclick="joinVoiceChannel('General')">
                <span class="icon">üîä</span> General
            </div>
            <div id="users-General" class="voice-user-list"></div>

            <div class="channel-item" onclick="joinVoiceChannel('Games')">
                <span class="icon">üîä</span> Games
            </div>
            <div id="users-Games" class="voice-user-list"></div>
        </div>

        <div class="voice-panel" id="voicePanel">
            <div class="v-status">Voice Connected</div>
            <div class="v-channel" id="currentVoiceName">General</div>
            <div class="v-controls">
                <button class="btn-disconnect" onclick="leaveVoice()" title="–í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è">‚ùå –í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è</button>
            </div>
        </div>
        
        <div style="background:#292b2f; padding:10px; display:flex; align-items:center;">
            <div class="v-avatar" id="myAvatarMini">?</div>
            <div style="margin-left:8px;">
                <div style="font-weight:bold; font-size:14px; color:white;" id="myUsernameDisplay">User</div>
                <div style="font-size:12px; color:#b9bbbe;">#0001</div>
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header"><span class="icon" style="font-size:20px; margin-right:10px;">#</span> –≥–æ–ª–æ–≤–Ω–∏–π</div>
        <div class="messages" id="messagesList"></div>
        <div class="input-area">
            <div class="input-box">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." onkeypress="handleKey(event)">
            </div>
        </div>
    </div>

    <div id="audioContainer" style="display:none;"></div>

    <script>
        // --- 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–ò–°–¢–ï–ú–ò ---
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://gun-eu.herokuapp.com/gun']);
        const chat = gun.get('wezzy-server-final-fix'); 
        let myUser = "Anon";
        let peer = null;
        let myStream = null;
        
        // --- 2. –õ–û–ì–Ü–ö–ê –í–•–û–î–£ ---
        function login() {
            const input = document.getElementById('usernameInput').value;
            if(input.trim()) {
                myUser = input;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('myUsernameDisplay').innerText = myUser;
                document.getElementById('myAvatarMini').innerText = myUser.charAt(0).toUpperCase();
                initChat();
            }
        }

        // --- 3. –¢–ï–ö–°–¢–û–í–ò–ô –ß–ê–¢ ---
        function handleKey(e) { if(e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value;
            if(!text.trim()) return;

            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            chat.set({
                user: myUser, text: text, time: time, createdAt: Date.now(), type: 'msg'
            });
            input.value = "";
        }

        function initChat() {
            chat.map().once((data) => {
                if(!data) return;
                
                // –Ø–∫—â–æ —Ü–µ —Å–∏–≥–Ω–∞–ª –¥–ª—è –¥–∑–≤—ñ–Ω–∫–∞ (—Ö—Ç–æ—Å—å –∑–∞–π—à–æ–≤ –≤ –≥–æ–ª–æ—Å–æ–≤–∏–π)
                if(data.type === 'call-signal') {
                    handleVoiceSignal(data);
                    return;
                }
                
                // –Ø–∫—â–æ —Ü–µ –∑–≤–∏—á–∞–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if(data.text && !document.getElementById(data.createdAt)) {
                    const list = document.getElementById('messagesList');
                    const msg = document.createElement('div');
                    msg.className = 'message';
                    msg.id = data.createdAt;
                    msg.innerHTML = `
                        <div class="msg-avatar">${data.user.charAt(0).toUpperCase()}</div>
                        <div class="msg-info">
                            <h4>${data.user} <span class="msg-time">${data.time}</span></h4>
                            <div class="msg-text">${data.text}</div>
                        </div>`;
                    list.appendChild(msg);
                    list.scrollTop = list.scrollHeight;
                }
            });
        }

        // --- 4. –ì–û–õ–û–°–û–í–ò–ô –ó–í'–Ø–ó–û–ö (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---
        
        function joinVoiceChannel(channelName) {
            if(myStream) leaveVoice(); // –Ø–∫—â–æ –≤–∂–µ –¥–µ—Å—å —î - –≤–∏—Ö–æ–¥–∏–º–æ

            // –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è
            document.getElementById('voicePanel').style.display = 'block';
            document.getElementById('currentVoiceName').innerText = channelName;
            document.querySelector('.v-status').innerText = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";
            document.querySelector('.v-status').style.color = "yellow";
            
            // –î–æ–¥–∞—î–º–æ —Å–µ–±–µ –≤ —Å–ø–∏—Å–æ–∫
            addUserToList(channelName, myUser, true);

            // –ó–∞–ø–∏—Ç –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                myStream = stream;

                // !!! STUN –°–ï–†–í–ï–†–ò (–¶–µ –≤–∏–ø—Ä–∞–≤–ª—è—î –ø—Ä–æ–±–ª–µ–º—É –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç—ñ)
                peer = new Peer(null, {
                    config: {
                        'iceServers': [
                            { url: 'stun:stun.l.google.com:19302' },
                            { url: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    document.querySelector('.v-status').innerText = "Voice Connected";
                    document.querySelector('.v-status').style.color = "#3ba55c";

                    // –ö–∞–∂–µ–º–æ –≤—Å—ñ–º: "–Ø –∑–∞–π—à–æ–≤, –æ—Å—å –º—ñ–π ID"
                    chat.set({
                        user: myUser,
                        peerId: id,
                        channel: channelName,
                        type: 'call-signal',
                        createdAt: Date.now()
                    });
                });

                // –ö–æ–ª–∏ –¥–∑–≤–æ–Ω—è—Ç—å –Ω–∞–º
                peer.on('call', (call) => {
                    call.answer(myStream); // –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ
                    call.on('stream', (remoteStream) => {
                        playAudio(remoteStream);
                    });
                });

            }).catch(err => {
                alert("–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞!");
                leaveVoice();
            });
        }

        function handleVoiceSignal(data) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –º–∏ –≤ –≥–æ–ª–æ—Å—ñ, —á–∏ —Ü–µ –Ω–∞—à –∫–∞–Ω–∞–ª, —á–∏ —Ü–µ –Ω–µ –º–∏ —Å–∞–º—ñ
            const myChannel = document.getElementById('currentVoiceName').innerText;
            const isVoiceActive = document.getElementById('voicePanel').style.display === 'block';

            if(isVoiceActive && data.channel === myChannel && data.user !== myUser) {
                // –î–æ–¥–∞—î–º–æ —ñ–∫–æ–Ω–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Å–ø–∏—Å–æ–∫
                addUserToList(data.channel, data.user, false);

                // –Ø–∫—â–æ —Å–∏–≥–Ω–∞–ª —Å–≤—ñ–∂–∏–π (–º–µ–Ω—à–µ 1 —Ö–≤–∏–ª–∏–Ω–∏), –¥–∑–≤–æ–Ω–∏–º–æ –π–æ–º—É
                if(Date.now() - data.createdAt < 60000 && data.peerId) {
                    console.log("–î–∑–≤–æ–Ω—é: " + data.user);
                    const call = peer.call(data.peerId, myStream);
                    call.on('stream', (remoteStream) => {
                        playAudio(remoteStream);
                    });
                }
            }
        }

        function playAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            document.getElementById('audioContainer').appendChild(audio);
            // –°–ø—Ä–æ–±–∞ –∑–∞–ø—É—Å–∫—É (—ñ–Ω–∫–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∏ –±–ª–æ–∫—É—é—Ç—å)
            audio.play().catch(e => console.log("Autoplay block:", e));
        }

        function leaveVoice() {
            if(myStream) {
                myStream.getTracks().forEach(track => track.stop());
                myStream = null;
            }
            if(peer) {
                peer.destroy();
                peer = null;
            }
            document.getElementById('voicePanel').style.display = 'none';
            document.getElementById('audioContainer').innerHTML = ""; 
            
            // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
            document.querySelectorAll('.voice-user-list').forEach(div => div.innerHTML = '');
        }

        function addUserToList(channel, name, isMe) {
            const list = document.getElementById('users-' + channel);
            // –©–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏
            if(list.innerHTML.includes(name)) return;

            const div = document.createElement('div');
            div.className = 'voice-user';
            div.innerHTML = `
                <div class="v-avatar" style="${isMe ? '' : 'background-color:#faa61a;'}">${name[0].toUpperCase()}</div>
                <div class="v-name">${name}</div>
            `;
            list.appendChild(div);
        }
    </script>
</body>
</html>
