<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>WEZZY | Private Server</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #36393f; color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ЕКРАН ВХОДУ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2f3136; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 10;
        }
        .card { background: #202225; padding: 30px; border-radius: 10px; text-align: center; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-create { background-color: #5865f2; }
        .btn-join { background-color: #3ba55c; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #000; background: #40444b; color: white; box-sizing: border-box; }

        /* ОСНОВНИЙ ІНТЕРФЕЙС */
        #app-screen { display: none; flex: 1; flex-direction: row; }
        
        /* БІЧНА ПАНЕЛЬ */
        .sidebar { width: 250px; background: #2f3136; padding: 20px; display: flex; flex-direction: column; }
        .server-code-box { background: #202225; padding: 10px; border-radius: 5px; margin-bottom: 20px; word-break: break-all; }
        .code-display { color: #faa61a; font-weight: bold; font-family: monospace; font-size: 18px; cursor: pointer; }
        .status { font-size: 12px; color: gray; margin-bottom: 10px; }
        .user-list { flex: 1; overflow-y: auto; }
        .user-item { display: flex; align-items: center; margin-bottom: 5px; padding: 5px; background: #36393f; border-radius: 5px; }
        .dot { width: 10px; height: 10px; background: #3ba55c; border-radius: 50%; margin-right: 10px; }

        /* ЧАТ */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #36393f; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #40444b; padding: 10px; border-radius: 8px; max-width: 80%; }
        .msg.me { align-self: flex-end; background: #5865f2; }
        .msg-input-area { padding: 20px; background: #2f3136; display: flex; }
        .msg-input { flex: 1; padding: 10px; border-radius: 5px; border: none; background: #40444b; color: white; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: #5865f2;">WEZZY DISCORD</h1>
        <div class="card" id="step1">
            <p>Як тебе звати?</p>
            <input type="text" id="username" placeholder="Твій Нікнейм">
            <button class="btn btn-create" onclick="createRoom()">Я АДМІН (Створити)</button>
            <div style="margin: 10px 0;">--- АБО ---</div>
            <button class="btn btn-join" onclick="showJoinInput()">Я УЧАСНИК (Ввійти)</button>
        </div>

        <div class="card" id="step2" style="display:none;">
            <p>Введи код від Адміна:</p>
            <input type="text" id="roomCodeInput" placeholder="Код підключення">
            <button class="btn btn-join" onclick="joinRoom()">ПІДКЛЮЧИТИСЯ</button>
            <button class="btn" style="background:#ed4245" onclick="location.reload()">НАЗАД</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="sidebar">
            <div style="font-weight: bold; margin-bottom: 5px;">КОД СЕРВЕРА (Натисни):</div>
            <div class="server-code-box" onclick="copyCode()">
                <div class="code-display" id="myIdDisplay">...</div>
            </div>
            
            <div class="status" id="statusText">Очікування...</div>
            <div style="font-weight: bold; margin-bottom: 10px;">КОРИСТУВАЧІ В ГОЛОСІ:</div>
            <div class="user-list" id="userList">
                </div>
            <button class="btn" style="background:#ed4245; margin-top:10px;" onclick="location.reload()">Вийти</button>
        </div>

        <div class="chat-area">
            <div class="messages" id="messages">
                <div class="msg">Вітаємо у чаті!</div>
            </div>
            <div class="msg-input-area">
                <input type="text" class="msg-input" id="chatInput" placeholder="Написати повідомлення..." onkeypress="if(event.key==='Enter') sendChat()">
            </div>
        </div>
    </div>

    <div id="audio-container"></div>

    <script>
        let peer;
        let myStream;
        let myName;
        let connections = []; // Список підключень (для адміна)

        // 1. СТВОРЕННЯ СЕРВЕРА (АДМІН)
        function createRoom() {
            myName = document.getElementById('username').value || "Admin";
            startPeer(null); // null означає "дай мені випадковий ID"
        }

        // 2. ВХІД ДО ІНШОГО (КЛІЄНТ)
        function showJoinInput() {
            myName = document.getElementById('username').value || "User";
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }

        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value;
            if (!code) return alert("Введи код!");
            startPeer(code);
        }

        // 3. ОСНОВНА ЛОГІКА
        function startPeer(targetId) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            document.getElementById('statusText').innerText = "Отримання доступу до мікрофону...";

            // Спочатку беремо мікрофон
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                myStream = stream;
                document.getElementById('statusText').innerText = "Підключення до мережі...";
                
                // Створюємо Peer
                peer = new Peer();

                peer.on('open', (id) => {
                    document.getElementById('myIdDisplay').innerText = id;
                    document.getElementById('statusText').innerText = "Онлайн";
                    addUserToUI(myName + " (Я)");

                    // Якщо ми "Приєднуємось" (є targetId), то дзвонимо Адміну
                    if (targetId) {
                        connectToAdmin(targetId);
                    }
                });

                // Коли хтось дзвонить НАМ
                peer.on('call', (call) => {
                    console.log("Вхідний дзвінок...");
                    call.answer(myStream); // Відповідаємо
                    
                    call.on('stream', (remoteStream) => {
                        playAudio(remoteStream);
                        addUserToUI("Користувач (Голос)");
                    });

                    // Для чату (якщо ми Адмін, зберігаємо з'єднання)
                    call.on('close', () => alert("Хтось вийшов"));
                });

                // Для текстового чату
                peer.on('connection', (conn) => {
                    setupDataConnection(conn);
                });

                peer.on('error', (err) => {
                    alert("Помилка: " + err.type);
                    document.getElementById('statusText').innerText = "Помилка з'єднання";
                });

            })
            .catch(err => {
                alert("Немає мікрофона! " + err);
                location.reload();
            });
        }

        // 4. ПІДКЛЮЧЕННЯ ДО АДМІНА
        function connectToAdmin(adminId) {
            document.getElementById('statusText').innerText = "Дзвонимо адміну...";
            
            // Дзвінок (Аудіо)
            const call = peer.call(adminId, myStream);
            call.on('stream', (adminStream) => {
                playAudio(adminStream);
                document.getElementById('statusText').innerText = "Підключено до Адміна!";
                addUserToUI("АДМІН");
            });

            // Чат (Дані)
            const conn = peer.connect(adminId);
            conn.on('open', () => {
                conn.send({ type: 'name', name: myName }); // Представляємось
                connections.push(conn);
            });
            setupDataConnection(conn);
        }

        // 5. ОБРОБКА ЧАТУ
        function setupDataConnection(conn) {
            conn.on('data', (data) => {
                if(data.type === 'chat') {
                    addMessage(data.sender, data.msg, false);
                }
                if(data.type === 'name') {
                    addUserToUI(data.name); // Показати ім'я в списку
                }
            });
            connections.push(conn);
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if(!msg) return;

            addMessage(myName, msg, true); // Собі

            // Всім іншим
            connections.forEach(conn => {
                conn.send({ type: 'chat', sender: myName, msg: msg });
            });
            input.value = "";
        }

        // 6. ДОПОМІЖНІ ФУНКЦІЇ
        function playAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            document.getElementById('audio-container').appendChild(audio);
        }

        function addMessage(sender, text, isMe) {
            const div = document.createElement('div');
            div.className = "msg " + (isMe ? "me" : "");
            div.innerHTML = `<b>${sender}:</b> ${text}`;
            document.getElementById('messages').appendChild(div);
            // Скрол вниз
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function addUserToUI(name) {
            const list = document.getElementById('userList');
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `<div class="dot"></div> ${name}`;
            list.appendChild(div);
        }

        function copyCode() {
            const code = document.getElementById('myIdDisplay').innerText;
            navigator.clipboard.writeText(code);
            alert("Код скопійовано! Надішли його другу.");
        }
    </script>
</body>
</html>
